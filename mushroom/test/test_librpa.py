#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""test LibRPA related utitlies"""
import unittest as ut
from io import StringIO

from mushroom import librpa


class test_read_stdout(ut.TestCase):
    """Test reading standard output"""

    def test_read_quasi_particle_energies(self):
        # multiple k-points case
        stdout = """
spin  1, k-point    1: (0.00000, 0.00000, 0.00000)
----------------------------------------------------------------------------------------------------------------------------
State              occ             e_mf             v_xc            v_exx           ReSigc           ImSigc             e_qp
----------------------------------------------------------------------------------------------------------------------------
    1          2.00000      -1790.77527       -153.07556       -244.86918         -0.13380          0.05898      -1882.70242
    2          2.00000         -5.57966        -13.26760        -14.13742          1.94627         -0.04455         -4.50347
    3          0.00000         -2.60827        -15.34527        -10.17580         -3.36010         -0.06585         -0.79917

spin  1, k-point    2: (0.00000, 0.00000, 0.33333)
----------------------------------------------------------------------------------------------------------------------------
State              occ             e_mf             v_xc            v_exx           ReSigc           ImSigc             e_qp
----------------------------------------------------------------------------------------------------------------------------
    1          2.00000      -1790.77527       -153.07556       -244.86931         -0.13380          0.05899      -1882.70254
    2          2.00000         -6.83276        -12.75309        -14.12568          2.21741         -0.04096         -5.98821
    3          0.00000         -3.25669        -13.74644         -9.07172         -2.77568         -0.06215         -1.35789

"""
        bs, kpts = librpa.read_quasi_particle_energies_stdout(StringIO(stdout))
        self.assertEqual(bs.nspins, 1)
        self.assertEqual(bs.nkpts, 2)
        self.assertEqual(bs.nbands, 3)
        self.assertEqual(bs.fund_gap(), 3.14558)

        # single k-points case
        stdout = """
spin  1, k-point    1: (0.00000, 0.00000, 0.00000)
----------------------------------------------------------------------------------------------------------------------------
State              occ             e_mf             v_xc            v_exx           ReSigc           ImSigc             e_qp
----------------------------------------------------------------------------------------------------------------------------
    1          2.00000      -1790.77527       -153.07556       -244.86918         -0.13380          0.05898      -1882.70242
    2          2.00000      -1790.77527       -153.07558       -244.86953         -0.13377          0.05902      -1882.70273
    3          2.00000       -140.53907        -47.30431        -75.93964          1.44707         -7.11626       -167.72705
    4          2.00000       -140.53121        -47.31481        -75.94360          1.45300         -7.14569       -167.70674
    5          2.00000        -96.56460        -47.22660        -67.66063          5.82782         -2.99540       -111.17056
    6          2.00000        -96.56458        -47.22663        -67.66070          5.82782         -2.99540       -111.17057
    7          2.00000        -96.56457        -47.22664        -67.66070          5.82784         -2.99540       -111.17054
    8          2.00000        -96.54755        -47.25729        -67.69715          5.89175         -3.00337       -111.09539
    9          2.00000        -96.54753        -47.25732        -67.69722          5.89176         -3.00337       -111.09540
   10          2.00000        -96.54752        -47.25733        -67.69723          5.89177         -3.00337       -111.09537
   11          2.00000        -17.95787        -11.76838        -18.70396          5.64483         -0.96990        -19.24837
   12          2.00000         -5.58210        -13.26764        -14.13753          1.94650         -0.04455         -4.50575
   13          2.00000         -5.58042        -13.26753        -14.13731          1.94630         -0.04455         -4.50415
   14          2.00000         -5.57966        -13.26760        -14.13742          1.94627         -0.04455         -4.50347
   15          0.00000         -2.60827        -15.34527        -10.17580         -3.36010         -0.06585         -0.79917
   16          0.00000         -2.55034        -12.66795         -7.80825         -2.53657         -0.04429         -0.22746
   17          0.00000         -2.54917        -12.66801         -7.80806         -2.53697         -0.04427         -0.22644
   18          0.00000         -2.54792        -12.66794         -7.80805         -2.53696         -0.04424         -0.22524

"""
        bs, kpts = librpa.read_quasi_particle_energies_stdout(StringIO(stdout))
        self.assertEqual(bs.nspins, 1)
        self.assertEqual(bs.nkpts, 1)
        self.assertEqual(bs.nbands, 18)
        self.assertEqual(bs.fund_gap(), 3.7043)

if __name__ == "__main__":
    ut.main()
